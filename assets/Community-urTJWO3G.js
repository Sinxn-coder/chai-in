import{j as e,m as g,A as G}from"./framer-BMT5hQ7X.js";import{r as c}from"./router-DOtJe_Np.js";import{u as J,s as a}from"./index-Dm4jgvHZ.js";import{T as K}from"./Toast-BwML1H3D.js";import{P as Q,r as B,V as L,U as A,H as Z,g as ee,W as te,B as se,X as q}from"./lucide-DqyMvtym.js";import{f as oe}from"./utils-Ctx6mZEP.js";import"./vendor-b0vXyz-r.js";import"./supabase-CtFrdYha.js";const ge=()=>{const{user:r}=J(),[v,y]=c.useState([]),[H,S]=c.useState(!0),[$,_]=c.useState(!1),[E,d]=c.useState(null),[W,F]=c.useState(null),[T,R]=c.useState("initial"),[C,D]=c.useState(null),[U,N]=c.useState(""),[z,M]=c.useState(!1),[re,m]=c.useState(""),P=async()=>{console.log("ðŸ” Fetching posts..."),S(!0),m("Fetching posts...");try{if(!r){console.log("âŒ No user authenticated"),m("No user logged in"),y([]),S(!1);return}console.log("âœ… User authenticated:",r.id),m("User authenticated, fetching posts...");const{data:t,error:l}=await a.from("community_posts").select("*").order("created_at",{ascending:!1});if(l){console.error("âŒ Error fetching posts:",l),d({message:"Failed to load posts: "+l.message,type:"error"}),m("Error: "+l.message),S(!1);return}if(console.log("ðŸ“Š Raw posts data:",t),m(`Found ${t?.length||0} posts`),t&&t.length>0){const o=[...new Set(t.map(n=>n.user_id))];console.log("ðŸ‘¥ User IDs to fetch:",o);const{data:s,error:p}=await a.from("user_preferences").select("user_id, username, display_name, avatar_url").in("user_id",o);p&&console.error("âŒ Error fetching users:",p),console.log("ðŸ‘¤ Users data:",s);const u={};s?.forEach(n=>u[n.user_id]=n);const b=t.map(n=>n.id),{data:h,error:x}=await a.from("post_likes").select("post_id, user_id").in("post_id",b),{data:j,error:i}=r?await a.from("saved_posts").select("post_id").eq("user_id",r.id):{data:[]};x&&console.error("âŒ Error fetching likes:",x),i&&console.error("âŒ Error fetching saved posts:",i),console.log("â¤ï¸ Likes data:",h),console.log("ðŸ”– Saved posts data:",j);const k={},I={};h?.forEach(n=>{k[n.post_id]=(k[n.post_id]||0)+1,n.user_id===r?.id&&(I[n.post_id]=!0)});const w={};j?.forEach(n=>{w[n.post_id]=!0});const f=t.map(n=>({...n,likes_count:k[n.id]||0,author:u[n.user_id]||{display_name:"Foodie",username:null,avatar_url:null},isLikedByUser:!!I[n.id],isSavedByUser:!!w[n.id]}));console.log("âœ¨ Processed posts:",f),y(f),m(`Successfully loaded ${f.length} posts`)}else console.log("ðŸ“­ No posts found"),m("No posts in database"),y([])}catch(t){console.error("ðŸ’¥ Error in fetchPosts:",t),d({message:"Failed to load posts: "+t.message,type:"error"}),m("Unexpected error: "+t.message)}finally{S(!1)}};c.useEffect(()=>{P();const t=()=>{P()};window.addEventListener("userProfileUpdated",t);const l=a.channel("community_posts_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"community_posts"},o=>{console.log("ðŸ†• New post detected:",o),P()}).subscribe();return()=>{window.removeEventListener("userProfileUpdated",t),a.removeChannel(l)}},[r]);const O=async(t,l)=>{console.log("ðŸš€ Starting post creation...",{imageFile:t.name,caption:l});try{if(!r){d({message:"Please login to create posts",type:"error"});return}const{data:o,error:s}=await a.from("user_preferences").select("*").eq("user_id",r.id).maybeSingle();if(s&&console.error("âŒ Error checking user preferences:",s),console.log("ðŸ‘¤ User preferences check:",o),!o){console.log("ðŸ†• Creating user preferences...");const{data:j,error:i}=await a.from("user_preferences").insert({user_id:r.id,display_name:r.user_metadata?.full_name||r.email?.split("@")[0]||"User",avatar_url:r.user_metadata?.avatar_url||null,notifications_enabled:!0,notify_new_spots:!0,notify_review_replies:!0,notify_weekly_digest:!1}).select().single();if(i)throw console.error("âŒ Error creating user preferences:",i),i;console.log("âœ… User preferences created:",j)}console.log("ðŸ“¤ Uploading image...");const p=`${r.id}-${Date.now()}.${t.name.split(".").pop()}`,{error:u}=await a.storage.from("food-images").upload(`community/${p}`,t);if(u)throw console.error("âŒ Image upload error:",u),u;const{data:{publicUrl:b}}=a.storage.from("food-images").getPublicUrl(`community/${p}`);console.log("âœ… Image uploaded successfully:",b),console.log("ðŸ’¾ Creating post in database...");const{data:h,error:x}=await a.from("community_posts").insert({user_id:r.id,image_url:b,caption:l}).select().single();if(x)throw console.error("âŒ Post creation error:",x),x;console.log("ðŸŽ‰ Post created successfully:",h),d({message:"Post shared successfully! ðŸŽ‰",type:"success"}),_(!1),R("initial"),D(null),N(""),console.log("ðŸ”„ Refreshing posts..."),await P()}catch(o){console.error("ðŸ’¥ Complete post creation error:",o),d({message:"Failed to share post: "+o.message,type:"error"})}},Y=async(t,l)=>{if(!r){d({message:"Please login to like posts",type:"error"});return}try{const{data:o}=await a.from("post_likes").select("*").eq("post_id",t).eq("user_id",r.id).maybeSingle();o?(await a.from("post_likes").delete().eq("id",o.id),y(v.map(s=>s.id===t?{...s,likes_count:Math.max(0,s.likes_count-1),isLikedByUser:!1}:s))):(await a.from("post_likes").insert({post_id:t,user_id:r.id}),y(v.map(s=>s.id===t?{...s,likes_count:(s.likes_count||0)+1,isLikedByUser:!0}:s)))}catch(o){console.error("âŒ Error toggling like:",o),d({message:"Failed to update like",type:"error"})}},V=({post:t,onClose:l})=>{const[o,s]=c.useState([]),[p,u]=c.useState(""),[b,h]=c.useState(!0),x=async()=>{h(!0);const{data:i}=await a.from("post_comments").select("*").eq("post_id",t.id).order("created_at",{ascending:!1});if(i){const k=[...new Set(i.map(f=>f.user_id))],{data:I}=await a.from("user_preferences").select("user_id, display_name, avatar_url").in("user_id",k),w={};I?.forEach(f=>w[f.user_id]=f),s(i.map(f=>({...f,user:w[f.user_id]||{display_name:"User",avatar_url:null}})))}else s([]);h(!1)};c.useEffect(()=>{x()},[t.id]);const j=async()=>{if(!(!p.trim()||!r))try{await a.from("post_comments").insert({post_id:t.id,user_id:r.id,comment:p.trim()}),u(""),x(),d({message:"Comment added! ðŸ’¬",type:"success"})}catch(i){console.error("âŒ Error adding comment:",i),d({message:"Failed to add comment",type:"error"})}};return e.jsx(g.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.8)",zIndex:9999,display:"flex",alignItems:"flex-end"},onClick:l,children:e.jsxs(g.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},style:{background:"#ffffff",width:"100%",borderTopLeftRadius:"24px",borderTopRightRadius:"24px",padding:"20px",maxHeight:"80vh",overflowY:"auto",boxShadow:"0 -4px 20px rgba(0,0,0,0.15)"},onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h3",{style:{fontSize:"1.2rem",fontWeight:"700",color:"#1a1a1a",margin:0},children:"Comments"}),e.jsx("button",{onClick:l,style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:e.jsx(q,{size:20,color:"#666"})})]}),b?e.jsx("div",{style:{textAlign:"center",padding:"40px"},children:e.jsx(B,{className:"animate-spin",color:"#666"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"12px",marginBottom:"20px",maxHeight:"400px",overflowY:"auto"},children:o.length===0?e.jsx("div",{style:{textAlign:"center",padding:"40px",color:"#999"},children:"No comments yet. Be the first to comment! ðŸ’­"}):o.map(i=>e.jsxs("div",{style:{display:"flex",gap:"12px",padding:"12px",background:"#f8f9fa",borderRadius:"12px"},children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",background:"#e9ecef",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:i.user?.avatar_url?e.jsx("img",{src:i.user.avatar_url,style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx(A,{size:18,color:"#666"})}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"0.9rem",color:"#1a1a1a",marginBottom:"4px"},children:i.user?.display_name||"User"}),e.jsx("div",{style:{color:"#666",fontSize:"0.85rem",lineHeight:"1.4"},children:i.comment})]})]},i.id))}),e.jsxs("div",{style:{display:"flex",gap:"8px",padding:"12px",background:"#f8f9fa",borderRadius:"20px"},children:[e.jsx("input",{type:"text",value:p,onChange:i=>u(i.target.value),placeholder:"Add a comment...",style:{flex:1,padding:"12px 16px",borderRadius:"16px",border:"none",outline:"none",fontWeight:"500",background:"#ffffff",color:"#1a1a1a",fontSize:"0.9rem"}}),e.jsx("button",{onClick:j,style:{padding:"12px 20px",borderRadius:"16px",background:"#007bff",color:"white",border:"none",fontWeight:"600",cursor:"pointer",fontSize:"0.9rem"},children:"Send"})]})]})]})})},X=()=>{const t=s=>{s&&(D(s),R("caption"))},l=s=>{const p=s.target.files[0];t(p)},o=async()=>{if(!C||!U.trim()){d({message:"Please add image and caption",type:"error"});return}M(!0),await O(C,U.trim()),M(!1)};return e.jsx(g.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.8)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>_(!1),children:e.jsxs(g.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},style:{background:"#ffffff",borderRadius:"20px",padding:"24px",width:"90%",maxWidth:"450px",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"},onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:[e.jsx("h3",{style:{fontSize:"1.4rem",fontWeight:"700",color:"#1a1a1a",margin:0},children:"Create Post"}),e.jsx("button",{onClick:()=>_(!1),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:e.jsx(q,{size:24,color:"#666"})})]}),T==="initial"&&e.jsxs("div",{style:{textAlign:"center"},children:[e.jsxs("div",{style:{width:"140px",height:"140px",border:"3px dashed #ddd",borderRadius:"20px",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",cursor:"pointer",background:"#f8f9fa",transition:"all 0.3s ease"},onClick:()=>document.getElementById("fileInput").click(),onMouseOver:s=>s.target.style.borderColor="#007bff",onMouseOut:s=>s.target.style.borderColor="#ddd",children:[e.jsx(L,{size:36,color:"#666"}),e.jsx("span",{style:{color:"#666",fontSize:"0.95rem",marginTop:"8px"},children:"Add Photo"})]}),e.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"center"},children:[e.jsxs("button",{onClick:()=>document.getElementById("fileInput").click(),style:{padding:"14px 24px",borderRadius:"20px",background:"#007bff",color:"white",border:"none",fontWeight:"600",cursor:"pointer",fontSize:"0.95rem",transition:"background 0.3s ease"},onMouseOver:s=>s.target.style.background="#0056b3",onMouseOut:s=>s.target.style.background="#007bff",children:[e.jsx(L,{size:18,style:{marginRight:"8px",verticalAlign:"middle"}}),"Choose Photo"]}),e.jsx("input",{id:"fileInput",type:"file",accept:"image/*",onChange:l,style:{display:"none"}})]})]}),T==="caption"&&C&&e.jsxs("div",{children:[e.jsx("div",{style:{width:"100%",height:"220px",borderRadius:"16px",overflow:"hidden",marginBottom:"20px",background:"#f8f9fa",border:"1px solid #e9ecef"},children:e.jsx("img",{src:URL.createObjectURL(C),style:{width:"100%",height:"100%",objectFit:"cover"}})}),e.jsx("textarea",{value:U,onChange:s=>N(s.target.value),placeholder:"Share your food experience...",style:{width:"100%",padding:"16px",borderRadius:"16px",border:"1px solid #e9ecef",outline:"none",fontWeight:"500",background:"#ffffff",color:"#1a1a1a",fontSize:"1rem",minHeight:"120px",resize:"vertical",marginBottom:"20px",fontFamily:"inherit"}}),e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[e.jsx("button",{onClick:()=>R("initial"),style:{padding:"14px 20px",borderRadius:"20px",background:"#f8f9fa",color:"#666",border:"1px solid #e9ecef",fontWeight:"600",cursor:"pointer",fontSize:"0.95rem"},children:"Back"}),e.jsx("button",{onClick:o,disabled:z,style:{padding:"14px 24px",borderRadius:"20px",background:z?"#6c757d":"#007bff",color:"white",border:"none",fontWeight:"600",cursor:z?"not-allowed":"pointer",fontSize:"0.95rem",flex:1,transition:"background 0.3s ease"},children:z?e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:[e.jsx(B,{className:"animate-spin",size:16}),e.jsx("span",{style:{marginLeft:"8px"},children:"Posting..."})]}):"Share Post"})]})]})]})})};return e.jsxs("div",{style:{minHeight:"100vh",background:"#f8f9fa",paddingBottom:"80px"},children:[E&&e.jsx(K,{message:E.message,type:E.type,onClose:()=>d(null)}),e.jsxs("div",{style:{position:"fixed",top:"0",left:"0",right:"0",padding:"20px",background:"#ffffff",borderBottom:"1px solid #e9ecef",boxShadow:"0 2px 8px rgba(0,0,0,0.08)",borderRadius:"0 0 30px 30px",overflow:"hidden",zIndex:1e3},children:[e.jsx("div",{style:{position:"absolute",top:"-50px",left:"-50px",width:"150px",height:"150px",background:"linear-gradient(135deg, #007bff, #0056b3)",borderRadius:"50%",opacity:.1}}),e.jsx("div",{style:{position:"absolute",top:"-30px",right:"-30px",width:"100px",height:"100px",background:"linear-gradient(135deg, #007bff, #0056b3)",borderRadius:"50%",opacity:.1}}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",position:"relative",zIndex:1},children:[e.jsxs("div",{children:[e.jsx("h1",{style:{fontSize:"1.8rem",fontWeight:"700",color:"#1a1a1a",margin:"0 0 4px 0"},children:"Community"}),e.jsx("p",{style:{fontSize:"0.95rem",color:"#666",margin:0},children:"Share your food experiences"})]}),e.jsxs(g.button,{whileTap:{scale:.95},onClick:()=>_(!0),style:{background:"#007bff",color:"white",border:"none",padding:"14px 20px",borderRadius:"20px",fontWeight:"600",cursor:"pointer",boxShadow:"0 4px 12px rgba(0,123,255,0.3)",display:"flex",alignItems:"center",gap:"8px",fontSize:"0.95rem"},children:[e.jsx(Q,{size:20}),"Create Post"]})]})]}),e.jsx("div",{style:{padding:"20px",paddingTop:"120px"},children:H?e.jsxs("div",{style:{textAlign:"center",padding:"60px 20px"},children:[e.jsx(B,{className:"animate-spin",color:"#666",size:32}),e.jsx("p",{style:{color:"#666",marginTop:"16px",fontSize:"1rem"},children:"Loading posts..."})]}):v.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"80px 20px",background:"#ffffff",borderRadius:"16px",boxShadow:"0 2px 8px rgba(0,0,0,0.08)"},children:[e.jsx("div",{style:{width:"100px",height:"100px",background:"#f8f9fa",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",border:"2px solid #e9ecef"},children:e.jsx(L,{size:36,color:"#666"})}),e.jsx("h3",{style:{color:"#1a1a1a",fontWeight:"700",margin:"0 0 12px 0",fontSize:"1.3rem"},children:"No posts yet"}),e.jsx("p",{style:{color:"#666",fontSize:"1rem",lineHeight:"1.6",marginBottom:"24px"},children:"Be the first to share your food experience with the community! ðŸ½ï¸"}),e.jsx(g.button,{whileTap:{scale:.95},onClick:()=>_(!0),style:{padding:"14px 28px",borderRadius:"20px",background:"#007bff",color:"white",border:"none",fontWeight:"600",cursor:"pointer",fontSize:"1rem",boxShadow:"0 4px 12px rgba(0,123,255,0.3)"},children:"Create First Post"})]}):e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"20px"},children:v.map((t,l)=>e.jsxs(g.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:l*.1},style:{background:"#ffffff",borderRadius:"16px",overflow:"hidden",boxShadow:"0 2px 12px rgba(0,0,0,0.08)",border:"1px solid #e9ecef"},children:[e.jsxs("div",{style:{padding:"16px",display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx("div",{style:{width:"44px",height:"44px",borderRadius:"50%",background:"#f8f9fa",overflow:"hidden",flexShrink:0,border:"2px solid #e9ecef"},children:t.author.avatar_url?e.jsx("img",{src:t.author.avatar_url,style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(A,{size:20,color:"#666"})})}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:"700",fontSize:"1rem",color:"#1a1a1a",marginBottom:"2px"},children:t.author.username||t.author.display_name}),e.jsx("div",{style:{fontSize:"0.85rem",color:"#666"},children:oe(new Date(t.created_at),{addSuffix:!0})})]})]}),e.jsx("div",{style:{position:"relative",width:"100%",paddingTop:"75%"},children:e.jsx("img",{src:t.image_url,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover"},onError:o=>{o.target.style.display="none"}})}),e.jsxs("div",{style:{padding:"16px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"20px",marginBottom:"12px"},children:[e.jsxs(g.button,{whileTap:{scale:.9},onClick:()=>Y(t.id,t.likes_count),style:{background:"none",border:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx(Z,{size:22,color:t.isLikedByUser?"#e74c3c":"#666",fill:t.isLikedByUser?"#e74c3c":"none"}),e.jsx("span",{style:{fontSize:"0.9rem",fontWeight:"600",color:t.isLikedByUser?"#e74c3c":"#666"},children:t.likes_count||0})]}),e.jsxs(g.button,{whileTap:{scale:.9},onClick:()=>F(t),style:{background:"none",border:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx(ee,{size:22,color:"#666"}),e.jsx("span",{style:{fontSize:"0.9rem",fontWeight:"600",color:"#666"},children:"Comment"})]}),e.jsxs(g.button,{whileTap:{scale:.9},style:{background:"none",border:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx(te,{size:22,color:"#666"}),e.jsx("span",{style:{fontSize:"0.9rem",fontWeight:"600",color:"#666"},children:"Share"})]}),e.jsx(g.button,{whileTap:{scale:.9},onClick:async()=>{if(!r){d({message:"Please login to save posts",type:"error"});return}try{const{data:o}=await a.from("saved_posts").select("*").eq("user_id",r.id).eq("post_id",t.id).maybeSingle();o?(await a.from("saved_posts").delete().eq("id",o.id),d({message:"Post removed from saved",type:"success"})):(await a.from("saved_posts").insert({user_id:r.id,post_id:t.id}),d({message:"Post saved to profile!",type:"success"})),y(v.map(s=>s.id===t.id?{...s,isSavedByUser:!o}:s))}catch(o){console.error("Error saving post:",o),d({message:"Failed to save post",type:"error"})}},style:{background:"none",border:"none",cursor:"pointer",marginLeft:"auto"},children:e.jsx(se,{size:22,color:t.isSavedByUser?"#007bff":"#666",fill:t.isSavedByUser?"#007bff":"none"})})]}),t.caption&&e.jsxs("div",{style:{fontSize:"0.95rem",lineHeight:"1.5",color:"#1a1a1a",fontWeight:"500"},children:[e.jsx("span",{style:{fontWeight:"700",marginRight:"6px"},children:t.author.username||t.author.display_name}),t.caption]})]})]},t.id))})}),e.jsxs(G,{children:[$&&e.jsx(X,{}),W&&e.jsx(V,{post:W,onClose:()=>F(null)})]})]})};export{ge as default};
