import{j as a,m as C}from"./framer-BMT5hQ7X.js";import{u as J,r as s}from"./router-DOtJe_Np.js";import{s as T}from"./index-0cjaDKRs.js";import{S as Q}from"./SpotCard-KxfEdeVi.js";import{S as X}from"./SkeletonLoader-D7onCYtA.js";import{T as Z}from"./Toast-BwML1H3D.js";import{a as tt,M as et}from"./lucide-DqyMvtym.js";import"./vendor-b0vXyz-r.js";import"./supabase-CtFrdYha.js";import"./ImageSlider-D9DlSLMK.js";const jt=({lang:z})=>{J();const[u,D]=s.useState([]),[E,f]=s.useState(!0),[i,I]=s.useState(""),[ot,$]=s.useState([]),[at,_]=s.useState([]),[L,F]=s.useState(null),[st,nt]=s.useState(null),[rt,it]=s.useState("All Kerala"),[ct,lt]=s.useState(!1),[dt,pt]=s.useState(""),[A,R]=s.useState(!1),[d,y]=s.useState(null),[j,k]=s.useState({}),[n,B]=s.useState(""),[b,M]=s.useState([]),[W,m]=s.useState(!1);s.useEffect(()=>{const t=setTimeout(()=>{B(i)},300);return()=>clearTimeout(t)},[i]),s.useEffect(()=>{(async()=>{f(!0);try{await Promise.all([K(),q(),P()])}finally{f(!1)}})()},[]),s.useEffect(()=>{(async()=>{if(i.trim()&&i.trim().length>=2){const o=await N(i);M(o),m(o.length>0)}else M([]),m(!1)})()},[i]),s.useEffect(()=>{(async()=>{if(n.trim()&&n.trim().length>=2){if(j[n.toLowerCase()]){y(j[n.toLowerCase()]);return}R(!0);const o=await U(n);y(o),o&&k(e=>({...e,[n.toLowerCase()]:o})),R(!1)}else y(null)})()},[n,j]);const K=async()=>{f(!0);const{data:t,error:o}=await T.from("spots").select("*").eq("is_verified",!0).order("created_at",{ascending:!1});o?(console.error("Error fetching spots:",o),F({message:"Failed to load spots",type:"error"})):D(t||[]),f(!1)},q=async()=>{const t=new Date(Date.now()-6048e5),{data:o}=await T.from("spots").select("*").eq("is_verified",!0).gte("created_at",t.toISOString()).order("created_at",{ascending:!1}).limit(5);$(o||[])},P=async()=>{const{data:t}=await T.from("spots").select("*").eq("is_verified",!0).order("created_at",{ascending:!1}).limit(5);_(t||[])};function H(t,o,e,r){var p=6371,c=(e-t)*Math.PI/180,g=(r-o)*Math.PI/180,l=Math.sin(c/2)*Math.sin(c/2)+Math.cos(t*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(g/2)*Math.sin(g/2),x=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),S=p*x;return S}const N=async t=>{if(!t||t.length<2)return[];try{const e=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t+", Kerala, India")}&limit=5&addressdetails=1&featuretype=city`)).json();if(e&&e.length>0)return e.map(r=>({display_name:r.display_name,lat:parseFloat(r.lat),lng:parseFloat(r.lon),name:r.address?.city||r.address?.town||r.address?.village||r.display_name.split(",")[0].trim()})).filter(r=>{const p=r.name.toLowerCase(),c=t.toLowerCase();return p.includes(c)||c.includes(p)})}catch(o){console.error("Error getting location suggestions:",o)}return[]},U=async t=>{try{let e=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t+", Kerala, India")}&limit=1&featuretype=city`)).json();if((!e||e.length===0)&&(e=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t+", Kerala, India")}&limit=1`)).json()),e&&e.length>0)return{lat:parseFloat(e[0].lat),lng:parseFloat(e[0].lon)}}catch(o){console.error("Error getting location coordinates:",o)}return null},h=s.useMemo(()=>{if(!n.trim()||n.trim().length<2)return u;const t=n.toLowerCase().trim();return d?u.filter(e=>H(e.latitude,e.longitude,d.lat,d.lng)<=30):u.filter(e=>{const r=e.name&&e.name.toLowerCase().includes(t),p=e.location&&e.location.toLowerCase().includes(t);let c=!1;return e.tags&&Array.isArray(e.tags)&&e.tags.length>0&&(c=e.tags.some(g=>{if(!g)return!1;const l=g.toLowerCase(),x=l.replace(/\s+/g,""),S=l.replace(/\s+/g,"-"),G=l.replace(/-/g,""),v=t.replace(/\s+/g,""),w=t.replace(/\s+/g,"-");return t.length>=2&&l.includes(t)||v.length>=2&&x.includes(v)||w.length>=2&&S.includes(w)||t.length>=2&&G.includes(t)||t.length>=2&&t.includes(l)||v.length>=2&&v.includes(x)||w.length>=2&&w.includes(S)})),r||p||c})},[u,n,d]),V=t=>{y(t),I(t.name),m(!1),M([]),k(o=>({...o,[t.name.toLowerCase()]:t}))},Y=()=>{i.trim()&&i.trim().length>=2&&b.length>0&&m(!0)},O=()=>{setTimeout(()=>{m(!1)},200)};return a.jsxs("div",{style:{minHeight:"100vh",background:"var(--bg-cream)",padding:"20px"},children:[L&&a.jsx(Z,{message:L.message,type:L.type,onClose:()=>F(null)}),a.jsx(C.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},style:{textAlign:"center",marginBottom:"30px"},children:n.trim()?a.jsxs(a.Fragment,{children:[a.jsx("h1",{style:{fontSize:"2rem",fontWeight:"900",color:"var(--primary)",marginBottom:"10px"},children:d?"Nearby Spots":"Search Results"}),a.jsx("p",{style:{color:"var(--text-muted)",fontSize:"1rem"},children:d?`Showing ${h.length} spots within 30km of "${n}"`:`Showing ${h.length} spots for "${n}"`})]}):a.jsxs(a.Fragment,{children:[a.jsx("h1",{style:{fontSize:"2rem",fontWeight:"900",color:"var(--primary)",marginBottom:"10px"},children:"Explore All Spots"}),a.jsx("p",{style:{color:"var(--text-muted)",fontSize:"1rem"},children:"Discover amazing food spots across Kerala"})]})}),a.jsxs(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},style:{background:"white",padding:"20px",borderRadius:"20px",boxShadow:"var(--shadow-md)",marginBottom:"30px"},children:[a.jsx("div",{style:{display:"flex",gap:"12px",marginBottom:"16px"},children:a.jsxs("div",{style:{flex:1,position:"relative"},children:[a.jsx(tt,{size:20,color:"var(--text-muted)",style:{position:"absolute",left:"12px",top:"50%",transform:"translateY(-50%)"}}),a.jsx("input",{type:"text",placeholder:"Search dishes, restaurants, tags, locations...",value:i,onChange:t=>I(t.target.value),onFocus:Y,onBlur:O,style:{width:"100%",padding:"12px 12px 12px 40px",borderRadius:"16px",border:"2px solid var(--secondary)",background:"var(--bg-cream)",fontSize:"1rem",outline:"none"}}),W&&b.length>0&&a.jsx("div",{style:{position:"absolute",top:"100%",left:"0",right:"0",background:"white",border:"2px solid var(--secondary)",borderTop:"none",borderRadius:"0 0 16px 16px",maxHeight:"200px",overflowY:"auto",zIndex:1e3,boxShadow:"var(--shadow-md)"},children:b.map((t,o)=>a.jsxs("div",{onClick:()=>V(t),onMouseDown:e=>e.preventDefault(),style:{padding:"12px 16px",cursor:"pointer",borderBottom:"1px solid var(--border)",transition:"background-color 0.2s",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:e=>e.target.style.backgroundColor="var(--bg-cream)",onMouseLeave:e=>e.target.style.backgroundColor="white",children:[a.jsx(et,{size:16,color:"var(--primary)"}),a.jsxs("div",{children:[a.jsx("div",{style:{fontWeight:"600",color:"var(--text-main)",fontSize:"0.9rem"},children:t.name}),a.jsx("div",{style:{fontSize:"0.8rem",color:"var(--text-muted)",marginTop:"2px"},children:"Kerala, India"})]})]},o))})]})}),n.trim()&&n.trim().length>=2&&a.jsx("div",{style:{fontSize:"0.9rem",color:"var(--text-muted)",marginTop:"8px",fontStyle:"italic"},children:A?"Detecting location...":d?`Found ${h.length} spots within 30km of "${n}"`:`Found ${h.length} results for "${n}"`})]}),a.jsx(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.8},children:a.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"16px"},children:E?Array.from({length:6}).map((t,o)=>a.jsx(X,{type:"card"},`skeleton-${o}`)):h.map(t=>a.jsx(Q,{spot:t,lang:z},t.id))})})]})};export{jt as default};
